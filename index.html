<!DOCTYPE html>
<html>
<head>
  <title>Upload Image to S3</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1470.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    img { max-width: 300px; margin: 10px 0; }
    #preview, #output { display: block; }
  </style>
</head>
<body>
  <h2>Upload Image to S3</h2>
  <input type="file" id="fileInput" accept="image/jpeg, image/png"/>
  <button onclick="uploadFile()">Upload</button>
  <p id="status"></p>
  <p id="originalSize"></p>
  <p id="resizedSize"></p>
  <p id="resizedUrl"></p>

  <h3>Preview</h3>
  <img id="preview" src="#" alt="Preview" style="display: none;" />

  <h3>Processed Image</h3>
  <img id="output" src="#" alt="Output" style="display: none;" />

  <script>
    AWS.config.region = 'ap-south-1';
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: 'ap-south-1:34948a15-cf13-435c-b467-cf0344b93e1c'
    });

    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        document.getElementById('status').innerText = 'Please choose a file.';
        return;
      }

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('preview');
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);

      // Show original size
      document.getElementById('originalSize').innerText = `Original Image Size: ${(file.size / 1024).toFixed(2)} KB`;

      const s3 = new AWS.S3({
        apiVersion: '2006-03-01',
        params: { Bucket: 'image-processing-input-internship' }
      });

      const params = {
        Bucket: 'image-processing-input-internship',
        Key: file.name,
        Body: file,
        ContentType: file.type
      };

      document.getElementById('status').innerText = 'Uploading...';

      s3.upload(params, function (err, data) {
        if (err) {
          console.log(err);
          document.getElementById('status').innerText = 'Error: ' + err.message;
        } else {
          console.log('Upload success', data.Location);
          document.getElementById('status').innerText = 'Upload success. Processing...';

          // Construct resized filename (assuming Lambda renames with prefix)
          const resizedFileName = 'resized-' + file.name;
          const outputUrl = `https://image-processing-output-internship.s3.ap-south-1.amazonaws.com/${resizedFileName}`;

          // Show output after 5 seconds
          setTimeout(() => {
            const outputImg = document.getElementById('output');
            outputImg.src = outputUrl;
            outputImg.style.display = 'block';

            // Show output URL
            document.getElementById('resizedUrl').innerText = `Resized Image URL: ${outputUrl}`;

            // Try HEAD request to get resized size
            fetch(outputUrl, { method: 'HEAD' })
              .then(response => {
                const contentLength = response.headers.get('Content-Length');
                if (contentLength) {
                  const kb = (parseInt(contentLength) / 1024).toFixed(2);
                  document.getElementById('resizedSize').innerText = `Resized Image Size: ${kb} KB`;
                } else {
                  document.getElementById('resizedSize').innerText = 'Could not fetch resized image size.';
                }

                // Always print final success message
                document.getElementById('status').innerText = '✅ Image resized successfully.';
              })
              .catch(error => {
                console.log('HEAD error:', error);
                document.getElementById('resizedSize').innerText = 'Could not fetch resized image size.';
                document.getElementById('status').innerText = '✅ Image resized successfully.';
              });

          }, 5000); // delay for Lambda processing
        }
      });
    }
  </script>
</body>
</html>
